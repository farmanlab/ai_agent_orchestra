# アクセシビリティ要件定義ワークフロー

UIのアクセシビリティ要件を定義する詳細な手順です。

## 概要

```
1. spec.md の存在確認
   └─> なければ初期化

2. 画面構造を分析
   └─> 主要セクション、インタラクティブ要素を特定

3. セマンティクス要件を定義
   └─> 適切なHTML要素、ランドマーク

4. ARIA属性要件を定義
   └─> role、aria-*属性

5. フォーカス管理を定義
   └─> タブ順序、フォーカストラップ

6. 色・コントラストを確認
   └─> WCAG基準のコントラスト比

7. スクリーンリーダー対応を定義
   └─> 代替テキスト、読み上げ順序

8. キーボード操作を定義
   └─> キーバインド、操作可能性

9. spec.md の「アクセシビリティ」セクションを更新
```

---

## Step 0: spec.md の存在確認

### 実行

```bash
ls .outputs/{screen-id}/spec.md
```

---

## Step 1: 画面構造を分析

### 入力ソース

1. **生成済みHTML** (`index.html`)
2. **Figmaデザイン**
3. **他セクションの情報**（UI状態、インタラクション等）

### 特定する要素

| カテゴリ | 要素 |
|---------|------|
| ページ構造 | ヘッダー、メイン、フッター、サイドバー |
| ナビゲーション | メインナビ、ブレッドクラム、ページネーション |
| コンテンツ | 見出し階層、リスト、テーブル |
| フォーム | 入力フィールド、ボタン、ラベル |
| インタラクティブ | モーダル、タブ、アコーディオン、ドロップダウン |
| 通知 | トースト、アラート、バッジ |
| メディア | 画像、アイコン、動画 |

### 出力形式

```yaml
page_structure:
  landmarks:
    - type: header
      content: ロゴ、ナビゲーション、検索
    - type: main
      content: 講座一覧
    - type: footer
      content: リンク、コピーライト
      
  interactive_elements:
    - type: button
      count: 5
      examples: [送信ボタン, 検索ボタン, フィルターボタン]
    - type: link
      count: 20
      examples: [講座カード, ナビリンク]
    - type: form
      fields: [検索入力, フィルター選択]
```

---

## Step 2: セマンティクス要件を定義

### ランドマークの割り当て

| 画面要素 | HTML要素 | role | 備考 |
|---------|---------|------|------|
| ページヘッダー | `<header>` | banner | ページに1つ |
| メインナビ | `<nav>` | navigation | aria-label必要 |
| 検索フォーム | `<form>` | search | - |
| メインコンテンツ | `<main>` | main | ページに1つ |
| サイドバー | `<aside>` | complementary | - |
| フッター | `<footer>` | contentinfo | ページに1つ |

### 見出し階層

```
h1: ページタイトル（1つのみ）
  h2: 主要セクション
    h3: サブセクション
      h4: 詳細項目
```

**注意**: 見出しレベルをスキップしない（h1 → h3 は避ける）

### リスト構造

| コンテンツ | 推奨構造 |
|-----------|---------|
| 講座一覧 | `<ul>` + `<li>` |
| ナビゲーション | `<nav>` > `<ul>` > `<li>` > `<a>` |
| 手順 | `<ol>` + `<li>` |
| 用語定義 | `<dl>` + `<dt>` + `<dd>` |

---

## Step 3: ARIA属性要件を定義

### 必須属性の特定

| 要素 | 必須属性 | 条件 |
|------|---------|------|
| アイコンボタン | aria-label | 視覚的ラベルなし |
| 展開要素 | aria-expanded | アコーディオン、ドロップダウン |
| タブ | aria-selected | タブリスト内 |
| モーダル | aria-modal, aria-labelledby | ダイアログ |
| 進捗 | aria-valuenow, aria-valuemin, aria-valuemax | プログレスバー |
| ライブ領域 | aria-live | 動的更新コンテンツ |

### 属性値の決定

```markdown
| 要素 | 属性 | 値 | 説明 |
|------|------|-----|------|
| 検索ボタン | aria-label | "検索" | アイコンのみのため |
| メニューボタン | aria-expanded | "true/false" | 開閉状態 |
| メニューボタン | aria-controls | "nav-menu" | 制御対象ID |
| タブ1 | aria-selected | "true" | 選択中 |
| タブ2 | aria-selected | "false" | 非選択 |
```

---

## Step 4: フォーカス管理を定義

### タブ順序の決定

1. **論理的な順序**: 視覚的な配置に沿う
2. **重要な要素が先**: スキップリンク → メインナビ → コンテンツ
3. **tabindex使用ルール**:
   - `tabindex="0"`: フォーカス可能にする
   - `tabindex="-1"`: プログラムでのみフォーカス
   - `tabindex="1+"`: 避ける（順序を乱す）

### タブ順序の記述

```
1. スキップリンク
2. ロゴ（リンク）
3. メインナビゲーション項目（左→右）
4. 検索フィールド
5. 検索ボタン
6. メインコンテンツ内の要素（上→下、左→右）
7. フッターリンク
```

### フォーカス移動の定義

| イベント | フォーカス移動先 | 理由 |
|----------|----------------|------|
| モーダル表示 | モーダル内最初のフォーカス可能要素 | コンテキスト切り替え |
| モーダル閉じる | トリガー要素 | 元の位置に戻る |
| フォームエラー | 最初のエラーフィールド | 修正箇所を示す |
| 削除完了 | リストの次の項目または前の項目 | 削除された要素の代替 |
| ページ内リンク | 対象セクションの見出し | tabindex="-1"で |

### フォーカストラップ

モーダル/ダイアログでの実装要件：

```markdown
- モーダル表示中はモーダル外にフォーカスを移動させない
- Tab: 最後の要素 → 最初の要素
- Shift+Tab: 最初の要素 → 最後の要素
- Escape: モーダルを閉じる
```

### フォーカスインジケーター

```markdown
- 全てのフォーカス可能要素に視覚的なインジケーター
- outline: none は避ける（カスタムスタイルに置き換える場合のみ）
- コントラスト比 3:1 以上
- 推奨: 2px以上のアウトライン
```

---

## Step 5: 色・コントラストを確認

### 色情報の収集

デザイントークンまたはFigmaから色情報を取得：

```yaml
colors:
  text:
    primary: "#24243F"
    secondary: "#67717A"
  background:
    primary: "#FFFFFF"
    secondary: "#F8F9F9"
  interactive:
    button: "#0070E0"
    link: "#0070E0"
    error: "#D32F2F"
```

### コントラスト比の計算

各組み合わせについて：

| 要素 | 前景色 | 背景色 | 比率 | 判定 |
|------|--------|--------|------|------|
| 本文 | #24243F | #FFFFFF | 14.5:1 | ✓ AA |
| 補足 | #67717A | #FFFFFF | 5.2:1 | ✓ AA |
| ボタン | #FFFFFF | #0070E0 | 4.6:1 | ✓ AA |
| リンク | #0070E0 | #FFFFFF | 4.5:1 | ✓ AA |
| エラー | #D32F2F | #FFFFFF | 5.9:1 | ✓ AA |

### 基準を満たさない場合

```markdown
⚠️ コントラスト不足

| 要素 | 前景色 | 背景色 | 比率 | 必要 |
|------|--------|--------|------|------|
| プレースホルダー | #AAAAAA | #FFFFFF | 2.3:1 | 4.5:1 |

**推奨**: プレースホルダー色を #757575 以上の濃さに変更
```

### 色に依存しない情報伝達

確認項目：

- [ ] エラー状態: 色以外の指標（アイコン、テキスト）
- [ ] 必須項目: 色以外の指標（*マーク）
- [ ] リンク: 色以外の指標（下線）
- [ ] 状態表示: 色以外の指標（ラベル）

---

## Step 6: スクリーンリーダー対応を定義

### 代替テキストの定義

| 画像種別 | 対応 |
|---------|------|
| 情報的 | 内容を説明するalt |
| 装飾的 | alt="" または aria-hidden="true" |
| 機能的 | 機能を説明するalt/aria-label |
| 複雑 | 概要 + 詳細へのリンク |

### 読み上げテキストの定義

視覚的表現を読み上げ用に変換：

| 視覚的表現 | 読み上げテキスト |
|-----------|----------------|
| ★★★★☆ | 評価 5段階中4 |
| 75% プログレスバー | 進捗 75パーセント |
| 🔴 | （色に依存しない代替テキスト） |
| ✓ 完了 | 完了 |
| ... | （省略されている場合は完全なテキスト） |

### ライブリージョンの定義

| 要素 | aria-live | atomic | 用途 |
|------|-----------|--------|------|
| トースト通知 | polite | true | 成功/情報メッセージ |
| エラーアラート | assertive | true | 重要なエラー |
| 検索結果件数 | polite | true | 結果更新時 |
| フォームエラー | assertive | - | フィールドエラー |
| チャットメッセージ | polite | false | 新着メッセージ |

---

## Step 7: キーボード操作を定義

### 全機能のキーボードアクセス確認

チェックリスト：

- [ ] 全てのリンクにキーボードでアクセス可能
- [ ] 全てのボタンにキーボードでアクセス可能
- [ ] 全てのフォーム要素にキーボードでアクセス可能
- [ ] ドラッグ&ドロップに代替手段がある
- [ ] ホバーで表示される情報にキーボードでアクセス可能

### キーバインドの定義

| 操作 | キー | 対象要素 |
|------|------|---------|
| フォーカス移動 | Tab | 全体 |
| 実行 | Enter / Space | ボタン、リンク |
| キャンセル | Escape | モーダル、ドロップダウン |
| 選択移動 | ← / → | タブ、カルーセル |
| 項目選択 | ↑ / ↓ | ドロップダウン、メニュー |
| 先頭へ | Home | リスト内 |
| 末尾へ | End | リスト内 |

### カスタムショートカット

アプリケーション固有のショートカットがある場合：

```markdown
| ショートカット | 動作 | 備考 |
|---------------|------|------|
| Ctrl + K | 検索を開く | グローバル |
| Ctrl + S | 保存 | 編集画面 |
```

**注意**: OS/ブラウザのショートカットと競合しないこと

---

## Step 8: spec.md の「アクセシビリティ」セクションを更新

### 更新手順

1. **セクションを特定**

```markdown
<!-- 
================================================================================
SECTION: アクセシビリティ
Generated by: defining-accessibility-requirements
================================================================================
-->

## アクセシビリティ
```

2. **ステータスを更新**

```markdown
> **ステータス**: 完了 ✓  
> **生成スキル**: defining-accessibility-requirements  
> **更新日**: {DATE}  
> **準拠レベル**: WCAG 2.1 AA
```

3. **プレースホルダー `{{ACCESSIBILITY_CONTENT}}` を内容に置換**

4. **完了チェックリストを更新**

```markdown
- [x] アクセシビリティ (defining-accessibility-requirements)
```

5. **変更履歴に追記**

```markdown
| {DATE} | アクセシビリティ | defining-accessibility-requirementsにより生成 |
```

### 検証

- [ ] セクションが更新されている
- [ ] ステータスが「完了 ✓」
- [ ] セマンティクス要件が定義されている
- [ ] ARIA属性が明確
- [ ] フォーカス管理が定義されている
- [ ] コントラスト比が確認されている
- [ ] スクリーンリーダー対応が定義されている
- [ ] キーボード操作が定義されている

---

## エラーハンドリング

### 色情報が取得できない

```
対処:
1. Figmaから色情報を取得
2. デザイントークンから取得
3. 「要確認」として明示
```

### 複雑なインタラクションのパターンが不明

```
対処:
1. a11y-patterns.md から類似パターンを参照
2. WAI-ARIA Authoring Practices を参照
3. 「要確認」として明示
```

### デザインがアクセシビリティ基準を満たさない

```
対処:
1. 問題点を明確に記載
2. 推奨される修正案を提示
3. 設計者への確認事項としてリスト
```
