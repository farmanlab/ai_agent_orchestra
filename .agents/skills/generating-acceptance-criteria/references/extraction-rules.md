# Extraction Rules

spec.md の各セクションから受け入れ要件を抽出するための詳細ルールです。

## インタラクション変換ルール

### data-figma-interaction パターン

| パターン | 構文 | 変換ルール |
|----------|------|-----------|
| navigate | `tap:navigate:{target}` | 画面遷移を生成 |
| toggle | `tap:toggle:{state}` | 状態トグルを生成（2シナリオ） |
| show-modal | `click:show-modal:{modal}` | モーダル表示を生成 |
| toggle:tab | `tap:toggle:tab` | タブ切り替えを生成 |

#### navigate パターン

**入力:**
```markdown
| 閉じるボタン | `tap:navigate:top` | TOP画面へ遷移 |
```

**出力:**
```markdown
### AC-N01: 閉じるボタンによるTOP画面遷移

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | 本画面を表示している | 閉じるボタンをタップする | TOP画面に遷移する | 必須 |
```

#### toggle パターン

**入力:**
```markdown
| ブックマークアイコン | `tap:toggle:bookmark` | `default,bookmarked` | ブックマーク状態をトグル |
```

**出力:**
```markdown
### AC-I01: ブックマークのトグル

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | ブックマークが未登録状態 (default) | アイコンをタップする | ブックマーク登録状態 (bookmarked) に変化する | 必須 |
| 02 | ブックマークが登録状態 (bookmarked) | アイコンをタップする | 未登録状態 (default) に変化する | 必須 |
```

#### show-modal パターン

**入力:**
```markdown
| ドロップダウン | `click:show-modal:filter-modal` | フィルターモーダル表示 |
```

**出力:**
```markdown
### AC-I02: フィルターモーダルの表示

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | フィルターモーダルが非表示 | ドロップダウンをクリックする | フィルターモーダルが表示される | 必須 |
| 02 | フィルターモーダルが表示中 | モーダル外をクリックする | フィルターモーダルが閉じる | 推奨 |
```

#### toggle:tab パターン

**入力:**
```markdown
| タブ（お気に入り） | `tap:toggle:tab` | `default,active` | お気に入りタブに切り替え |
| タブ（すべての履歴） | `tap:toggle:tab` | `default,active` | すべての履歴タブに切り替え |
```

**出力:**
```markdown
### AC-I03: タブ切り替え

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | 「すべての履歴」タブが選択状態 | 「お気に入り」タブをタップする | 「お気に入り」タブが選択状態になる | 必須 |
| 02 | 「お気に入り」タブが選択状態 | 「すべての履歴」タブをタップする | 「すべての履歴」タブが選択状態になる | 必須 |
| 03 | 「お気に入り」タブが選択状態 | 「お気に入り」タブをタップする | 状態は変化しない（冪等） | 推奨 |
```

## data-figma-states 変換ルール

| states パターン | 生成するシナリオ |
|-----------------|------------------|
| `default,active` | default → active, active → default |
| `default,hover` | hover時の視覚変化（E2E向けはスキップ可） |
| `default,hover,active` | hover時 + click時の視覚変化 |
| `default,bookmarked` | 未登録 → 登録, 登録 → 未登録 |
| `default,selected,hover` | 選択状態の切り替え |
| `default,open` | 開閉の切り替え |
| `default,disabled` | disabled時は操作不可 |

### hover 状態の扱い

hover 状態は通常、視覚的な変化のみでテスト対象外とすることが多い。
ただし、以下の場合はシナリオを生成：

- ツールチップ表示
- サブメニュー表示
- プレビュー表示

```markdown
### AC-I04: カードホバー時のプレビュー

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | カードが表示されている | カードにホバーする | プレビュー画像が拡大表示される | 推奨 |
```

## 機能一覧変換ルール

### 基本変換

| 機能 | 説明 | → Given | When | Then |
|------|------|---------|------|------|
| {機能名} | {説明} | 正常なデータが存在する | 画面を表示する | {説明}される |

### 説明文の変換パターン

| 説明パターン | Then 変換 |
|-------------|----------|
| 「〜を表示」 | 「〜が表示される」 |
| 「〜の切り替え」 | 「〜が切り替わる」 |
| 「〜をフィルター」 | 「〜がフィルタリングされる」 |
| 「〜へ遷移」 | 「〜画面に遷移する」 |

### 例

**入力:**
```markdown
| 履歴一覧表示 | 月別にグループ化された履歴を表示 |
| タブ切り替え | 「お気に入り」「すべての履歴」の切り替え |
| フィルタリング | カテゴリ別（すべて/数学/英語等）のフィルター |
```

**出力:**
```markdown
### AC-D01: 履歴一覧表示

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | 履歴データが存在する | 画面を表示する | 月別にグループ化された履歴が表示される | 必須 |
| 02 | 2025年5月と4月の履歴がある | 画面を表示する | 「2025年5月」「2025年4月」のセクションが表示される | 必須 |

### AC-D02: タブ切り替え

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | 「すべての履歴」が選択状態 | 「お気に入り」をタップする | ブックマーク済みの履歴のみ表示される | 必須 |

### AC-D03: フィルタリング

| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| 01 | 「すべて」が選択状態 | 「数学」を選択する | 数学カテゴリの履歴のみ表示される | 必須 |
```

## 画面フロー変換ルール

### 流入遷移

```
Given: {遷移元}画面を表示している
When: {トリガー}
Then: 本画面に遷移する
```

**パラメータがある場合:**
```
Then: 本画面に遷移する（{パラメータ}が渡される）
```

### 流出遷移

```
Given: 本画面を表示している [AND {条件}]
When: {トリガー}
Then: {遷移先}画面に遷移する
```

### 内部状態遷移

```
Given: {現在状態}である
When: {トリガー}
Then: {遷移後状態}になる
```

## API マッピング変換ルール

### data-api-field バインディング

| HTML要素 | APIフィールド | 変換処理 | → Then |
|----------|---------------|----------|--------|
| `.month-header` | `year_month` | フォーマット | 「2024-01」が「2024年1月」形式で表示される |
| `.item__date` | `created_at` | formatDate | 日時がフォーマットされて表示される |
| `.item__preview` | `image_uri` | なし | 画像が正しく読み込まれる |

### API 呼び出し

| タイミング | → When |
|-----------|--------|
| 画面表示時 | 画面を表示する |
| フィルター変更時 | フィルターを変更する |
| ブックマークアイコンタップ時 | ブックマークアイコンをタップする |

### エラーハンドリング

API 呼び出しがある場合、以下のエラーシナリオを自動生成：

```markdown
| ID | Given | When | Then | 優先度 |
|----|-------|------|------|--------|
| E1 | APIが500エラーを返す | 画面を表示する | エラー画面が表示される | 推奨 |
| E2 | ネットワークエラーが発生する | 画面を表示する | エラーメッセージが表示される | 推奨 |
| E3 | APIがタイムアウトする | 画面を表示する | タイムアウトメッセージが表示される | 任意 |
```

## 表示条件変換ルール

| 条件パターン | Given | When | Then |
|-------------|-------|------|------|
| 「〜なし」「〜なし」 | データが0件 | 画面を表示する | 空状態画面が表示される |
| 「〜から遷移」 | {遷移元}から遷移した | 画面を表示する | {動作} |

## リストデータ変換ルール

### 空時

```
Given: {リストID}のデータが0件
When: 画面を表示する
Then: {空時の表示}が表示される
```

### 境界値

```
# 最小件数 > 0 の場合
Given: {リストID}のデータが{最小件数 - 1}件
When: 画面を表示する
Then: {空時の表示}が表示される

# 最大件数が有限の場合
Given: {リストID}のデータが{最大件数}件
When: 画面を表示する
Then: 全件が表示される

Given: {リストID}のデータが{最大件数 + 1}件以上
When: 画面を表示する
Then: ページネーション/無限スクロールが機能する
```

## 優先度判定ルール

| 条件 | 優先度 |
|------|--------|
| 機能一覧から抽出（主要機能） | 必須 |
| インタラクション（navigate, toggle）正常系 | 必須 |
| 画面遷移（主要フロー） | 必須 |
| タブ/フィルター切り替え | 必須 |
| API正常系 | 必須 |
| エラーハンドリング（500, ネットワーク） | 推奨 |
| 空状態、境界値 | 推奨 |
| hover状態 | 推奨 |
| 冪等性確認 | 推奨 |
| タイムアウト | 任意 |
| 細かい視覚変化 | 任意 |

## 重複判定ルール

以下の場合、重複とみなしてマージ：

1. **同一要素の同一操作**
   - AC-D と AC-I で同じ機能を記述している場合
   - → AC-I を優先（より詳細なシナリオ）

2. **同一遷移**
   - 画面フローとインタラクションで同じ遷移を記述
   - → 画面フロー（AC-N）を優先

3. **同一状態変化**
   - UI状態とインタラクションで同じ状態変化を記述
   - → インタラクション（AC-I）を優先

## ID 採番ルール

```
AC-{カテゴリ}{2桁連番}

例:
AC-D01, AC-D02, ...  # 表示
AC-I01, AC-I02, ...  # 操作
AC-N01, AC-N02, ...  # 遷移
AC-S01, AC-S02, ...  # 状態
AC-A01, AC-A02, ...  # API
AC-E01, AC-E02, ...  # エッジケース
```

各要件内のシナリオ:
```
{AC-ID}-{2桁連番}

例:
AC-I01-01, AC-I01-02, AC-I01-03
```
