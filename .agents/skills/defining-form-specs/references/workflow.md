# フォーム仕様定義ワークフロー

フォームフィールドの仕様を定義する詳細な手順です。

## 概要

```
1. spec.md の存在確認
   └─> なければ初期化

2. 入力フィールドを検出
   └─> HTML/Figmaからフォーム要素を抽出

3. フィールド属性を整理
   └─> 型、必須/任意、制約を文書化

4. バリデーションルールを定義
   └─> 形式、文字数、カスタムルール

5. エラーメッセージを定義
   └─> 各ルール違反時のメッセージ

6. バリデーションタイミングを決定
   └─> onChange/onBlur/onSubmit

7. 送信動作を定義
   └─> 送信条件、成功/失敗時の挙動

8. spec.md の「フォーム仕様」セクションを更新
```

---

## Step 0: spec.md の存在確認

### 実行

```bash
ls .agents/tmp/{screen-id}/spec.md
```

### フォームがない場合

入力フィールドが存在しない画面では：

```markdown
## フォーム仕様

> **ステータス**: 該当なし  
> **生成スキル**: defining-form-specs  
> **更新日**: {DATE}

この画面には入力フォームがありません。
```

---

## Step 1: 入力フィールドを検出

### HTMLから検出

```html
<!-- 標準入力 -->
<input type="text|email|password|number|tel|date|...">
<textarea>
<select>

<!-- チェック系 -->
<input type="checkbox">
<input type="radio">

<!-- ファイル -->
<input type="file">

<!-- data属性からの検出 -->
[data-figma-content="input"]
[data-figma-content="text_field"]
```

### Figmaから検出

コンポーネント名から検出：

- Input, TextField, TextInput
- Select, Dropdown, Picker
- Checkbox, Radio, Toggle, Switch
- DatePicker, TimePicker
- FileUpload, FilePicker

### 出力形式

```yaml
form_fields:
  - id: email
    label: メールアドレス
    type: email
    figma_node: "1234:5678"
    
  - id: password
    label: パスワード
    type: password
    figma_node: "1234:5679"
    
  - id: terms
    label: 利用規約に同意する
    type: checkbox
    figma_node: "1234:5680"
```

### 検証

- [ ] 全ての入力フィールドが検出された
- [ ] フィールドIDが一意である
- [ ] フィールドタイプが正確である

---

## Step 2: フィールド属性を整理

### 収集する属性

| 属性 | ソース | 説明 |
|------|--------|------|
| フィールドID | HTML id属性 / 推測 | 識別子 |
| ラベル | label要素 / Figmaテキスト | 表示名 |
| 入力タイプ | input type / コンポーネント | text/email/password等 |
| 必須/任意 | required属性 / デザイン | 必須マーク(*) |
| 初期値 | value属性 / Figma | デフォルト値 |
| プレースホルダー | placeholder / Figmaテキスト | 入力ヒント |
| 最大文字数 | maxlength / 推測 | 文字数制限 |
| 入力マスク | pattern / デザイン | フォーマット |

### デザインからの推測

| デザイン要素 | 推測できる属性 |
|-------------|---------------|
| `*` マーク | required |
| `(任意)` テキスト | optional |
| 文字数カウンター | maxLength |
| ヘルパーテキスト | バリデーションヒント |
| エラー状態のテキスト | エラーメッセージ |

---

## Step 3: バリデーションルールを定義

### ルール定義の情報源

1. **デザインから明示**: エラー状態、ヘルパーテキスト
2. **フィールドタイプから推測**: email → メール形式
3. **一般的なパターン適用**: validation-patterns.md参照
4. **要確認**: 推測できない場合

### ルール定義フォーマット

```yaml
validation_rules:
  - field: email
    rules:
      - type: required
        message: メールアドレスを入力してください
      - type: format
        condition: email
        message: 有効なメールアドレスを入力してください
      - type: maxLength
        condition: 254
        message: メールアドレスは254文字以内で入力してください
      - type: unique
        condition: API確認
        message: このメールアドレスは既に登録されています
        note: 要確認 - 重複チェックの要否
```

### 「要確認」の明示

推測に基づくルールは明示：

```markdown
| フィールド | ルール | 条件 | 備考 |
|-----------|--------|------|------|
| パスワード | pattern | 英数字混在 | **要確認**: 強度要件 |
| 電話番号 | format | 日本形式 | **要確認**: 国際番号の対応要否 |
```

---

## Step 4: エラーメッセージを定義

### メッセージ定義の原則

1. **ユーザーフレンドリー**: 技術用語を避ける
2. **具体的**: 何が問題か明確に
3. **建設的**: どう修正すればよいか示す
4. **一貫性**: 全フィールドで統一感

### メッセージのソース

| 優先度 | ソース |
|--------|--------|
| 1 | Figmaデザインのエラー状態テキスト |
| 2 | 一般的なパターン（validation-patterns.md） |
| 3 | 推測（フィールドタイプベース） |

### フォーマット

```markdown
| フィールド | ルール | エラーメッセージ |
|-----------|--------|-----------------|
| メールアドレス | required | メールアドレスを入力してください |
| メールアドレス | format | 有効なメールアドレスを入力してください |
| パスワード | required | パスワードを入力してください |
| パスワード | minLength | パスワードは8文字以上で入力してください |
```

---

## Step 5: バリデーションタイミングを決定

### タイミングの選択基準

| タイミング | 適用条件 | 例 |
|-----------|----------|-----|
| onChange | 即座にフィードバックが有用 | 文字数カウント、パスワード強度 |
| onBlur | 入力完了後に検証 | メール形式、必須チェック |
| onSubmit | 最終確認 | 全フィールド |
| debounced | API呼び出しを伴う | 重複チェック、存在確認 |

### 推奨設定

```markdown
| タイミング | 対象フィールド |
|-----------|---------------|
| onChange | パスワード強度インジケーター |
| onBlur | テキスト、メール、パスワード |
| debounced (500ms) | メール重複チェック（API） |
| onSubmit | 全フィールド（最終確認） |
```

---

## Step 6: 送信動作を定義

### 定義項目

| 項目 | 説明 |
|------|------|
| 送信ボタンラベル | ボタンに表示するテキスト |
| 活性条件 | ボタンがクリック可能になる条件 |
| 送信中の表示 | ローディング状態 |
| 成功時 | 遷移先、メッセージ |
| 失敗時 | エラー表示、フォーム状態 |
| 再送信 | 可否、条件 |

### フォーマット

```markdown
### 送信動作

| 項目 | 値 |
|------|-----|
| 送信ボタン | 登録する |
| 活性条件 | 必須フィールド入力済み & バリデーションエラーなし |
| 送信中 | ボタン非活性 + スピナー表示 + テキスト「送信中...」 |
| 成功時 | 完了画面へ遷移 |
| 失敗時 | エラーメッセージ表示（トースト）、入力内容維持 |
| 再送信 | エラー解消後に可能 |
```

### エラー種別と対応

| エラー種別 | 表示方法 | 例 |
|-----------|---------|-----|
| バリデーションエラー | フィールド直下 | 形式エラー |
| サーバーエラー | トースト/バナー | 通信エラー |
| ビジネスエラー | フィールド直下 or トースト | 重複登録 |

---

## Step 7: spec.md の「フォーム仕様」セクションを更新

### 更新手順

1. **セクションを特定**

```markdown
<!-- 
================================================================================
SECTION: フォーム仕様
Generated by: defining-form-specs
================================================================================
-->

## フォーム仕様
```

2. **ステータスを更新**

```markdown
> **ステータス**: 完了 ✓  
> **生成スキル**: defining-form-specs  
> **更新日**: {DATE}
```

3. **プレースホルダー `{{FORM_SPECS_CONTENT}}` を内容に置換**

4. **完了チェックリストを更新**

```markdown
- [x] フォーム仕様 (defining-form-specs)
```

5. **変更履歴に追記**

```markdown
| {DATE} | フォーム仕様 | defining-form-specsにより生成 |
```

### 検証

- [ ] セクションが更新されている
- [ ] ステータスが「完了 ✓」または「該当なし」
- [ ] 全フィールドが記載されている
- [ ] バリデーションルールが明確
- [ ] エラーメッセージが定義されている
- [ ] 送信動作が定義されている

---

## エラーハンドリング

### フォームが検出できない

```
対処: 「該当なし」としてセクションを更新
```

### バリデーションルールが不明

```
対処: 
1. フィールドタイプから一般的なルールを推測
2. 「要確認」として明示
3. 設計者への確認事項としてリスト
```

### エラーメッセージがデザインにない

```
対処:
1. validation-patterns.md のテンプレートを使用
2. 「要確認」として明示
```
