# Project Instructions

<!-- Auto-generated from .agents/rules/ - Do not edit directly -->


# Session Learning (Auto-Detection)

セッション中のやりとりから有用なパターンを自動検出し、再利用可能なKnowledgeとして提案する。

## 目次

1. [Workflow](#workflow)
2. [自動検出トリガー](#自動検出トリガー)
3. [提案フォーマット](#提案フォーマット)
4. [承認後の処理](#承認後の処理)
5. [提案のガイドライン](#提案のガイドライン)
6. [検出の頻度](#検出の頻度)
7. [具体例](#具体例)

## Workflow

検出から保存までの流れ：

```
Session Learning Workflow:
- [ ] Step 1: パターン検出（会話中に自動監視）
- [ ] Step 2: 提案生成（タスク完了後や会話の区切りで）
- [ ] Step 3: ユーザー確認待ち
- [ ] Step 4: 承認時 → ファイル作成
- [ ] Step 5: sync実行 → 全ツール反映
```

**Step 1: パターン検出**
- 会話中に以下のトリガーを監視
- 検出しても作業は中断しない

**Step 2: 提案生成**
- タスク完了後に提案を出力
- 1セッション最大3件まで

**Step 3-5: 承認と保存**
- ユーザーが「保存して」と返答したら実行
- `.agents/rules/` または `.agents/skills/` に保存
- `sync.sh all` で全ツールに反映

## 自動検出トリガー

以下のパターンを検出したら、**会話の流れを止めずに**提案を行う：

### 1. 修正フィードバック

ユーザーが訂正・修正した場合：

**検出キーワード:**

- 日本語: 「違う」「そうじゃなくて」「待って」「〜じゃなくて」「〜ではなく」
- 英語: "no,", "actually", "instead", "wait", "not that"

**アクション:** 訂正内容をRuleとして提案

### 2. 繰り返し指示

同じ内容の指示が**2回以上**出た場合：

**検出パターン:**

- 同じツール/ライブラリの指定（「pnpmを使って」「yarnで」）
- 同じフォーマット指定（「日本語で」「TypeScriptで」）
- 同じ手順の説明

**アクション:** 設定・規約をRuleとして提案

### 3. プロジェクト固有ルール

明示的な規約・慣習の言及：

**検出キーワード:**

- 日本語: 「このプロジェクトでは」「うちのチームは」「いつも」「必ず」「絶対に」
- 英語: "in this project", "we always", "our team", "never", "must"

**アクション:** 規約をRuleとして提案

### 4. 複雑ワークフロー完了

以下の条件を**すべて**満たすタスク完了時：

- 3ステップ以上の手順
- 再利用可能性が高い（汎用的な作業）
- 同様のタスクが今後も発生しそう

**アクション:** ワークフローをSkillとして提案

### 5. トラブルシュート解決

エラーや問題を解決した後：

**検出パターン:**

- エラー発生 → 調査 → 解決のフロー
- 「これで解決」「動いた」などの成功報告

**アクション:** 解決方法をRuleとして提案

## 提案フォーマット

検出時、以下の形式でインラインに提案：

```markdown
---
💡 **Knowledge提案**

| 項目 | 内容 |
|------|------|
| 種別 | Rule / Skill |
| 検出理由 | [修正/繰り返し/規約/ワークフロー/解決] |
| トリガー | `[いつこの知識を使うか]` |

**内容:**
> [具体的なルール/手順]

**保存先:** `.agents/rules/[name].md`

👉 承認する場合は「保存して」と返答
👉 編集する場合は修正内容を指示
👉 不要な場合はスキップ可（返答不要）
---
```

## 承認後の処理

ユーザーが承認したら：

1. **ファイル作成**: 指定の保存先に新規ファイルを作成
2. **Sync実行**: `.agents/scripts/sync/sync.sh all` で全ツールに反映
3. **報告**: 作成したファイルパスを通知

## 提案のガイドライン

### 提案すべきもの

- プロジェクト固有の設定・規約
- チーム共通のワークフロー
- 繰り返し使える解決パターン
- ツール/ライブラリの使い方

### 提案を控えるもの

- 一般的なベストプラクティス（すでに知られている）
- 一度限りの特殊なケース
- ユーザーの好み程度の軽微な指摘
- セキュリティに関わる機密情報

## 検出の頻度

- **過度な提案を避ける**: 1セッションで最大3件程度
- **重複回避**: 既存のrules/skillsと重複する内容は提案しない
- **タイミング**: タスク完了後や会話の区切りで提案（作業中は控える）

## 具体例

### Example 1: 修正フィードバック検出

**Before（修正前の会話）:**

```
User: Prismaマイグレーションして
AI: npx prisma migrate dev を実行しました
User: 違う、SQLを先に確認したかった
```

**After（提案生成）:**

```markdown
💡 **Knowledge提案**

| 項目 | 内容 |
|------|------|
| 種別 | Rule |
| 検出理由 | 修正フィードバック |
| トリガー | `Prismaマイグレーション実行時` |

**内容:**
> 1. `npx prisma migrate dev --create-only` でSQL生成
> 2. 生成されたSQLを確認
> 3. 問題なければ `npx prisma migrate dev` で適用

**保存先:** `.agents/rules/prisma-migration.md`
```

### Example 2: 繰り返し指示検出

**Before（繰り返しの会話）:**

```
User: pnpmでインストールして
AI: npm install を実行...
User: pnpmを使って
---
User: 依存関係追加して
AI: npm install lodash...
User: pnpmで
```

**After（提案生成）:**

```markdown
💡 **Knowledge提案**

| 項目 | 内容 |
|------|------|
| 種別 | Rule |
| 検出理由 | 繰り返し指示（2回以上） |
| トリガー | `パッケージ管理操作時` |

**内容:**
> このプロジェクトではパッケージマネージャーにpnpmを使用する。
> npm/yarnではなく、必ずpnpmコマンドを使用すること。

**保存先:** `.agents/rules/package-manager.md`
```

### Example 3: ワークフロー完了検出

**Before（複雑なタスク完了後）:**

```
User: PRを作成して
AI: 1. ブランチ作成 → 2. 変更をコミット → 3. プッシュ → 4. gh pr create
    完了しました
```

**After（提案生成）:**

```markdown
💡 **Knowledge提案**

| 項目 | 内容 |
|------|------|
| 種別 | Skill |
| 検出理由 | ワークフロー完了（4ステップ） |
| トリガー | `PR作成時` |

**内容:**
> ## PR作成ワークフロー
> 1. feature/xxx ブランチを作成
> 2. 変更をコミット（Conventional Commits形式）
> 3. リモートにプッシュ
> 4. `gh pr create` でPR作成

**保存先:** `.agents/skills/creating-pull-requests/`
```

# Terminology Mapping

ビジネス用語とコード（ファイル名・コンポーネント名）の対応表。

## 画面系

| 用語 | コード | 備考 |
|------|--------|------|
| 一覧画面 | `page.ts` | リスト表示画面 |

## コンポーネント系

| 用語 | コード | 備考 |
|------|--------|------|

## 処理系

| 用語 | コード | 備考 |
|------|--------|------|

## 使い方

ユーザーが上記の用語を使った場合、対応するコードを参照・編集する。

**例:**
- 「一覧画面を修正して」→ `page.ts` を編集
- 「一覧画面にボタンを追加して」→ `page.ts` 内のコンポーネントを編集

# Project Base Rules

## Communication
- 日本語でコミュニケーション
- 技術用語は英語のまま使用可

## Core Principles
- 推測せず、不明点は確認してから実装
- 既存パターンを尊重し、一貫性を保つ
- 最小限の変更で目的を達成

## Before Implementation
1. 要件の理解を確認
2. 影響範囲を特定
3. 既存コードのパターンを確認

## Code Quality
- 自己文書化コードを心がける
- マジックナンバー禁止
- 適切なエラーハンドリング

### Example: Magic Numbers

**Bad**:
```typescript
if (retries > 3) {
  throw new Error("Failed");
}
```

**Good**:
```typescript
const MAX_RETRIES = 3;
if (retries > MAX_RETRIES) {
  throw new Error("Failed after maximum retries");
}
```

## Testing
- 変更には対応するテストを含める
- 既存テストを壊さない
- エッジケースを考慮

## Git Workflow
- コミットは論理的な単位で
- コミットメッセージは変更内容を明確に
- WIP コミットはsquash前提
