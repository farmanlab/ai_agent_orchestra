---
description: PRレビューコメントに対応する（コメントごとに妥当性を評価し、対応を支援）
argument-hint: [PR URL]（省略時は現在のブランチのPRを使用）
allowed-tools: Bash(gh:*), Bash(git:*), Read, Edit, Write, Glob, Grep, Task, AskUserQuestion
---

# PRレビュー対応

## 指示

  以下のPRのレビューコメントに対応してください：

## 手順

  0. **PR URLの決定**
     - `$ARGUMENTS` が指定されている場合: それをPR URLとして使用
     - `$ARGUMENTS` が空の場合: `gh pr view --json url --jq .url` を実行して現在のブランチのPR URLを取得
     - PR URLが取得できない場合: エラーメッセージを表示して終了

  1. **PRコメントの取得**
     - 決定したPR URLを使用
     - `gh api` を使用してPRのレビューコメントを取得
     - URL形式: `https://github.com/{owner}/{repo}/pull/{number}`

  2. **各コメントについて以下を実行**

     a) **コメント内容の分析**
        - 指摘事項の内容を要約
        - 該当ファイルと行番号を特定
        - 関連するコードを読み取り

     b) **妥当性の評価**
        - 指摘が技術的に正しいか
        - コードの品質向上に寄与するか
        - プロジェクトの規約やベストプラクティスに沿っているか
        - 優先度（高/中/低）

     c) **対応方針の提示**
        - 具体的な修正方法を提案
        - 代替案があれば併記
        - 推奨（対応すべき / 対応推奨 / 任意 / 対応不要）

     d) **ユーザーへの確認**
        AskUserQuestion ツールを使用して以下を質問：
        - 「対応する」「スキップ」「詳細を確認」の選択肢を提示
        - 推奨理由を説明に含める

  3. **対応の実行**
     - ユーザーが「対応する」を選択した場合：
       - 該当ファイルを編集
       - 必要に応じてテストを実行
       - 変更内容を報告
       - 変更をコミット（`git commit`）
         - コミットメッセージは対応したコメントの内容を反映
         - 例: `fix: PRレビューコメント対応 - [コメントの要約]`
         - 複数のコメントに対応した場合は、まとめて1つのコミットにするか、コメントごとに個別にコミットするかは変更の関連性を考慮して決定
       - コミット後、対応したコメントIDとコミットハッシュ（`git rev-parse HEAD`）のマッピングを記録
         - 後でpush後にコメントを追加するために必要

  4. **完了報告**
     - 対応したコメント数
     - スキップしたコメント数
     - 残りの対応が必要なコメント（あれば）
     - 実行したコミットの情報（コミットハッシュ、コミットメッセージ）

  5. **Pushの確認と実行**
     - 全てのコメントに対応が完了した場合：
       - AskUserQuestion ツールを使用して、pushするかどうかをユーザーに確認
       - 選択肢: 「pushする」「pushしない」
       - ユーザーが「pushする」を選択した場合：
         - `git push` を実行してリモートにpush
         - pushが成功したことを確認

  6. **コメントへの対応通知**
     - pushが成功した後、対応した各コメントに対して commit revisionでコメントを追加
     - 対応したコメントIDとコミットハッシュのマッピングを保持しておく
     - `gh api` を使用して、各レビューコメントに対して返信コメントを追加：
       - エンドポイント: `POST /repos/{owner}/{repo}/pulls/{pull_number}/comments/{comment_id}/replies`
       - コメント本文: `対応しました。コミット: {commit_sha}`
       - または: `対応しました。コミット: {commit_sha[:7]}` (短縮版)
       - 各コメントに対応したコミットハッシュを正確に紐付けてコメントを追加

## 出力形式

  各コメントについて以下の形式で報告：

  コメント #N: [コメント者名]

  ファイル: path/to/file.ts:行番号

  指摘内容:
  （コメントの要約）

  妥当性評価: ⭐⭐⭐ (高/中/低)

- 理由: ...

  推奨: 対応すべき / 対応推奨 / 任意 / 対応不要

  対応方針:

- 方法1: ...
- 方法2（代替）: ...

## 注意事項

- [nit] や [optional] とマークされたコメントは優先度を下げる
- 質問形式のコメントは回答が必要か確認
- 複数のコメントが関連している場合はまとめて対応を提案
- コードの変更後は typecheck や lint が通ることを確認

  ファイル名: pr-review.md
  配置場所: ~/.claude/commands/pr-review.md
